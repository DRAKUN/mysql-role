---
- name: Check if mysql is already installed
  command: dpkg-query -W -f 'found' mysql-server
  changed_when: false
  failed_when: false
  register: installed_mysql

- name: Ensure MySQL Python libraries are installed
  apt:
    name: python-mysqldb
    state: present

- name: Ensure MySQL packages are installed
  apt:
    name: "{{ item }}"
    state: present
  with_items: "{{ mysql_packages }}"

- name: Copy my.cnf global MySQL configuration
  template:
    src: my.cnf.j2
    dest: "{{ mysql_config_file }}"
    owner: root
    group: root
    mode: 0644
  notify: restart mysql

- name: Ensure MySQL is started and enabled on boot
  service:
    name: mysql
    state: started
    enabled: yes

# This task set the initial password
# Use mysql_user construct to change it again
- name: Ensure root password is set the first time
  mysql_user:
    name: "{{ mysql_root_user }}"
    password: "{{ mysql_root_password }}"
    login_user: root
    login_host: localhost
  when: installed_mysql.stdout != 'found'

- include: databases.yml
- include: users.yml
