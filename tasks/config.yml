---

- name: MySQL | Copy global MySQL configuration
  template:
    src: my.cnf.j2
    dest: "{{ mysql_config_file }}"
    owner: root
    group: root
    mode: 0600
  notify: restart mysql

- name: MySQL | Ensure datadir exists
  file:
    path: "{{ mysql_datadir }}"
    state: directory
    owner: "{{ mysql_user }}"
    group: "{{ mysql_group }}"

- name: MySQL | Trying to initialize datadir
  command: /usr/sbin/mysqld --initialize-insecure --user={{ mysql_user }}
  ignore_errors: yes
  changed_when: false

- name: MySQL | Ensure MySQL is started and enabled on boot
  service:
    name: mysql
    state: started
    enabled: yes

- name: MySQL | Set root password
  mysql_user:
    name: "{{ mysql_root_user }}"
    password: "{{ mysql_root_password }}"
    login_user: root
    login_host: localhost
  when: "installed_mysql.stdout != 'Status: install ok installed'"
